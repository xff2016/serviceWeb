<!DOCTYPE html>
<html>
<head lang="en">
 <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"> 
<link rel='stylesheet prefetch' href='https://res.wx.qq.com/open/libs/weui/0.3.0/weui.css'>     <title>售后就在您身边</title>   
<style type="text/css">
body{
    font-family:Microsoft YaHei;
  line-height:2;
}
h1{
    font: Microsoft YaHei;
}
.weui_label{
  width: 5em;
}
</style>   

</head>

<body ontouchstart="" >
<div class="hd">
<h2 class="page_title"  style="text-align:center" ><img src="./Images/123.jpg" height="33" width="33" align="absmiddle">
工单反馈</h2>
</div>

<form name="form" action="../php/commit.php" method="post">
<div class="container">
    
  <!-- 客户信息 -->
  <div class="padding">
  <div class="weui_cells_title" style="background:#C0C0C0">客户信息确认</div>
  <div class="weui_cells">
    <div class="weui_cell">
      <div class="weui_cell_bd weui_cell_primary">
        <p>客户：</p>
      </div>
      <div class="weui_cell_ft" id="name">
      </div>
    </div>
    <div class="weui_cell">
      <div class="weui_cell_bd weui_cell_primary">
        <p>产品型号：</p>
      </div>
      <div class="weui_cell_ft" id="product">
      </div>
    </div>
    <div class="weui_cell">
      <div class="weui_cell_bd weui_cell_primary">
        <p>电话：</p>
      </div>
      <div class="weui_cell_ft"  id="phone">
      </div>
    </div>
  </div>
</div>

  <div class="weui_cells_title" style="background:#C0C0C0">反馈信息</div>

<div class="weui_cells weui_cells_form">
<!-- 是否解决问题 -->
    <div class="weui_cell weui_cell_switch">
      <div class="weui_cell_hd weui_cell_primary">是否解决问题</div>
      <div class="weui_cell_ft">
        <input class="weui_switch" id="switcher" type="checkbox" name="switcher">
      </div>
    </div>

<!-- 故障记录-->
    <div class="weui_cell">
        <div class="weui_cell_hd">
            <label class="weui_label">故障记录<font color="red"> *</font></label>
        </div>
        <div class="weui_cell_bd weui_cell_primary">
            <input class="weui_input" name="record" type="text" placeholder="简单记录故障表现" />
        </div>
    </div>

<!-- 检修日志-->
    <div class="weui_cell">
        <div class="weui_cell_hd">
            <label class="weui_label">检修日志<font color="red"> *</font></label>
        </div>
        <div class="weui_cell_bd weui_cell_primary">
            <input class="weui_input" name="maintenanceLog" type="text" placeholder="简单记录维修日志" />
        </div>
    </div>


</div>

<!-- 上传警告-->
  <div class="weui_dialog_alert" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
      <div class="weui_dialog_hd"><strong class="weui_dialog_title">警告</strong></div>
      <div class="weui_dialog_bd">弹窗内容，告知当前页面信息等</div>
      <div class="weui_dialog_ft">
        <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
      </div>
    </div>
  </div>

<!-- 具体问题描述-->
<div class="weui_cells_title" style="background:#C0C0C0">其他补充信息（选填）</div>
<!-- 图片上传-->
    <div class="weui_cells weui_cells_form">
      <div class="weui_cell">
        <div class="weui_cell_bd weui_cell_primary">
          <div class="weui_uploader">
            <div class="weui_uploader_hd weui_cell">
              <div class="weui_cell_bd weui_cell_primary">图片上传</div>
              <div class="weui_cell_ft js_counter">0/6</div>
            </div>
            <div class="weui_uploader_bd">
              <ul class="weui_uploader_files">
                <!-- 预览图插入到这 -->
              </ul>
              <div class="weui_uploader_input_wrp">
                <input class="weui_uploader_input js_file" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple="">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

<div class="weui_cells weui_cells_form">
    <div class="weui_cell">
        <div class="weui_cell_bd weui_cell_primary">
            <textarea name="maintenanceExtratext" class="weui_textarea" id="textarea" placeholder="若有其他特殊情况，请补充填写此栏信息，留作备存。" rows="3"></textarea>
            <div class="weui_textarea_counter"><span id="count">0</span>/120</div>
        </div>
    </div>
</div>

<div class="weui_btn_area">
    <a class="weui_btn weui_btn_primary" id="button" href="javascript:;">提交</a>
</div>


</form>
</body>

 <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='http://rawgit.com/progrape/weui.js/master/dist/weui.js'></script>

<!--显示cookie+判断输入是否合法-->
<script type="text/javascript">

             function getCookie(sName) {
                  var aCookie = document.cookie.split('; ');
                  for (var i=0; i < aCookie.length; i++) {
                         var aCrumb = aCookie[i].split('=');
                          if (sName == aCrumb[0])
                             return decodeURI(aCrumb[1]);
                        }
                        return '';
                }
                var name1 = decodeURI(getCookie("name"));
                var phone1 = decodeURI(getCookie("phone"));
                var product1= decodeURI(getCookie("product"));
                var model1 = decodeURI(getCookie("model"));

                var _name=document.getElementById("name");
                var _phone=document.getElementById("phone");
                var _product=document.getElementById("product");
                var _model=document.getElementById("model");

                 _name.innerHTML = name1;
                 _phone.innerHTML = phone1;
                 _product.innerHTML = '【'+product1+'】'+''+model1;

    $(function(){
    $('#button').on('click', function(e){
        var pairs = $('form').serialize().split(/&/gi);
        var data = {};
        pairs.forEach(function(pair) {
            pair = pair.split('=');
            data[pair[0]] = decodeURIComponent(pair[1] || '');
        });
        if(!data.record){
            $.weui.topTips('请输入故障记录');
            return;
        }
        else if(!data.maintenanceLog){
            $.weui.topTips('请输入维修日志');
            return;
        }
        else{
            Bmob.initialize("79e03dbceb4fcd76250ace233a63b2a6", "77e63caf02a8f27d04e33d49249f15e2");
            var UserData = Bmob.Object.extend("UserData");
            var query = new Bmob.Query(UserData);
            query.equalTo("phone", phone1);
            query.equalTo("name", name1);
            query.first({
                 success: function(object) {
                  object.set('state','已完成');
                  object.set('isEnd',1);
                  object.save(null, {
             success: function(objectUpdate) {
            },
          error: function(model, error) {
            alert("系统繁忙，请稍后再试!");
          }
        });
      }});
            form.submit();
        }
    
    })
})
</script> 

<!--上传图片并附有上传状态-->
<script type="text/javascript">$(function () {
    // 允许上传的图片类型
    var allowTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
    //10MB
    var maxSize = 10 * 1024 * 1024;
    // 图片最大宽度
    var maxWidth = 300;
    // 最大上传图片数量
    var maxCount = 6;
    $('.js_file').on('change', function (event) {
        var files = event.target.files;
        // 如果没有选中文件，直接返回
        if (files.length === 0) {
            return;
        }

        for (var i = 0, len = files.length; i < len; i++) {
            var file = files[i];
            var reader = new FileReader();

            // 如果类型不在允许的类型范围内
            if (allowTypes.indexOf(file.type) === -1) {
                $.weui.alert('该类型不允许上传');
                continue;
            }

            if (file.size > maxSize) {
                $.weui.alert('图片太大，不允许上传');
                continue;
            }

            if ($('.weui_uploader_file').length >= maxCount) {
                $.weui.alert('最多只能上传' + maxCount + '张图片');
                return;
            }

            reader.onload = function (e) {
                var img = new Image();
                img.onload = function () {
                    // 不要超出最大宽度
                    var w = Math.min(maxWidth, img.width);
                    // 高度按比例计算
                    var h = img.height * (w / img.width);
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    // 设置 canvas 的宽度和高度
                    canvas.width = w;
                    canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    var base64 = canvas.toDataURL('image/png');

                    // 插入到预览区
                    var $preview = $('<li class="weui_uploader_file weui_uploader_status" style="background-image:url(' + base64 + ')"><div class="weui_uploader_status_content">0%</div></li>');
                    $('.weui_uploader_files').append($preview);
                    var num = $('.weui_uploader_file').length;
                    $('.js_counter').text(num + '/' + maxCount);

                    // 然后假装在上传，可以post base64格式，也可以构造blob对象上传，也可以用微信JSSDK上传

                    var progress = 0;
                    function uploading() {
                        $preview.find('.weui_uploader_status_content').text(++progress + '%');
                        if (progress < 100) {
                            setTimeout(uploading, 30);
                        }
                        else {
                            // 如果是失败，塞一个失败图标
                            //$preview.find('.weui_uploader_status_content').html('<i class="weui_icon_warn"></i>');
                            $preview.removeClass('weui_uploader_status').find('.weui_uploader_status_content').remove();
                        }
                    }
                    setTimeout(uploading, 30);
                };

                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
});</script>

<!--问题描述-->
<script type="text/javascript">$(function(){
  var max = 120;
  $('#textarea').on('input', function(){
     var text = $(this).val();
     var len = text.length;
    
     $('#count').text(len);
    
     if(len > max){
       $(this).closest('.weui_cell').addClass('weui_cell_warn');
     }
     else{
       $(this).closest('.weui_cell').removeClass('weui_cell_warn');
     }
     
  });
})</script>

<script type="text/javascript">
$(function(){
  $('#switcher').on('change', function(){
    var isChecked = $(this).is(':checked');
    //$.weui.alert('开关状态：' + isChecked);
    console.log('开关状态：' + isChecked);
  });
});
</script>
    <script src="../js/bmob-min.js"></script>
</html>